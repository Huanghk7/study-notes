# Redis学习

## 2022.10.31

### 一、RDB快照

RDB 快照就是记录**某一个瞬间的内存数据，记录的是实际数据**，而 AOF 文件记录的是命令操作的日志，而不是实际的数据。

因此在 Redis 恢复数据时， RDB 恢复数据的效率会比 AOF 高些，因为直接**将 RDB 文件读入内存**就可以，不需要像 AOF 那样还需要**额外执行操作命令的步骤才能恢复数据**。

Redis 提供了两个命令来生成 RDB 文件，分别是 `save` 和 `bgsave`，他们的区别就在于是否在「主线程」里执行：

- 执行了 save 命令，就会在主线程生成 RDB 文件，由于和执行操作命令在同一个线程，所以如果写入 RDB 文件的时间太长，**会阻塞主线程**；
- 执行了 bgsave 命令，会创建一个子进程来生成 RDB 文件，这样可以**避免主线程的阻塞**；

RDB 文件的加载工作是在服务器启动时自动执行的，Redis 并没有提供专门用于加载 RDB 文件的命令。 

 RDB 快照的缺点，在服务器发生故障时，丢失的数据会比 AOF 持久化的方式更多，因为 RDB 快照是全量快照的方式，因此执行的频率不能太频繁，否则会影响 Redis 性能，而 AOF 日志可以以秒级的方式记录操作命令，所以丢失的数据就相对更少。 



### 二、Redis过期删除策略

Redis有四种给key设置过期时间的命令，分别是

1. expire key 100	// 100s后过期
2. pexpire key 100	// 100ms后过期
3. expireat key 100	// 某个时间戳过期（s）
4. pexpireat ket 100		// 某个时间戳过期（ms）

#### 2.1 判断key是否过期

当我们对一个key设置了过期时间，Redis会将这个key和过期时间存储到过期时间中去，完整流程为

![img](https://cdn.xiaolincoding.com/gh/xiaolincoder/redis/%E8%BF%87%E6%9C%9F%E7%AD%96%E7%95%A5/%E8%BF%87%E6%9C%9F%E5%88%A4%E6%96%AD%E6%B5%81%E7%A8%8B.jpg) 

#### 2.2 过期删除策略有哪些

常用的删除策略有以下三种

- 定时删除策略
- 惰性删除策略
- 定期删除策略

**定时删除策略**

做法：在设置key过期时间时，同时创建一个定时事件，在key达到过期时间时，执行该事件删除key

优点：可以保证已经过期的key尽快的删除，内存可以尽快释放。

缺点：这种策略会占用一定的cpu，当内存充足CPU紧张时，将CPU时间用在这种任务上，无疑会对服务器的响应时间和吞吐率照成影响。所以，定时策略对CPU不友好。

**惰性删除策略**

